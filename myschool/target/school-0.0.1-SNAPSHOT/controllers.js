Ext.define("School.controller.Reset_Close",{extend:"Ext.app.Controller",init:function(){this.control({"form button#reset":{click:School.util.SchoolGlobal.onResetButtonClick},"form button#cancel":{click:School.util.SchoolGlobal.onCancelButtonClick}})}});Ext.define("School.controller.Login",{extend:"Ext.app.Controller",requires:["School.util.MD5","School.util.Util"],views:["Login","Header","auth.CapsLockTooltip"],refs:[{ref:"capslockTooltip",selector:"capslocktooltip"},{ref:"loginPanel",selector:"login"}],init:function(a){this.control({});window.onresize=function(){var b=Ext.ComponentQuery.query("login")[0];b.setWidth(School.util.Util.getInner().width);b.setHeight(School.util.Util.getInner().height)}}});Ext.define("LoginGlobal",{statics:{getLocalStorage:function(d,c){if("localStorage" in window){var b=localStorage.getItem("account"),a=localStorage.getItem("password");return{name:b||"",password:a||""}}},setLocalStorage:function(b,a){if("localStorage" in window){localStorage.setItem("account",b);localStorage.setItem("password",a)}},submit:function(b,c){var a=Ext.ComponentQuery.query("login")[0];Ext.get(a.getEl()).mask("正在验证登陆信息...请等待...","loading");Ext.Ajax.request({url:zyHost+"teacher_website/login",params:{account:b,password:c},failure:function(g,d,e,f){Ext.get(a.getEl()).unmask();School.util.Util.showErrorMsg("连接服务器失败！")},success:function(k,e,f,j){LoginGlobal.setLocalStorage(b,c);Ext.get(a.getEl()).unmask();var d=School.util.Util.decodeJSON(k.responseText);console.log(d.userInfo);if(d.success){globalUserInfo=d.userInfo;zy_schoolId=d.userInfo.school_id;zy_classId=d.userInfo.class_id;zy_className=d.userInfo.class_name;zy_schoolName=d.schoolName;zy_logoUrl=d.logo;var h=globalUserInfo.teacher_info.classes,l=[];for(var g=0;g<h.length;g++){l=[h[g].id,h[g].name];zy_classes.push(l)}zy_teacherStore=Ext.create("School.store.school.TeacherMgr",{autoLoad:true,pageSize:1000});console.log(zy_classes);a.close();Ext.create("School.view.MyViewport")}else{School.util.Util.showErrorMsg("登陆失败！")}}})},clearLocalStorage:function(){}}});Ext.define("School.controller.Menu",{extend:"Ext.app.Controller",requires:["School.view.MainPanel","School.view.auth.UserMgr","School.util.Util","School.util.AuthUtil"],models:["menu.Root","menu.Item"],stores:["Menu"],views:["menu.Accordion","menu.Item","Header","User"],refs:[{ref:"mainPanel",selector:"mainpanel"}],init:function(a){this.control({mainmenu:{render:this.OnPanelRender},mainmenuitem:{select:this.onTreepanelSelect,itemclick:this.onTreepanelItemClick}})},OnPanelRender:function(d,b){var a=Ext.ComponentQuery.query("mainmenu")[0],c=this,e=Ext.ComponentQuery.query("appheader")[0];this.getMenuStore().load({param:{},callback:function(h,j,i){e.add({xtype:"label",style:{background:"url("+zy_logoUrl+") no-repeat center"},width:100,height:100});e.add({xtype:"label",html:'<div class="title"><h1>'+zy_schoolName+" </h1>优校云信息管理平台</div>",width:250});Ext.each(h,function(k){var m=Ext.create("School.view.menu.Item",{title:k.get("text"),iconCls:k.get("iconCls")});var l=Ext.create("Ext.Img",{cls:"nav",height:60,width:60,margin:"0 10",src:k.raw.imgUrl,title:k.get("text"),margin:"0 10"});e.add(l);Ext.each(k.items(),function(n){Ext.each(n.data.items,function(o){m.getRootNode().appendChild({text:o.get("text"),leaf:true,iconCls:o.get("iconCls"),id:o.get("id"),className:o.get("className")})})});a.add(m)});var g=Ext.create("Ext.menu.Menu",{allowOtherMenus:true,width:100,margin:"0 50 0 0",defaults:{},items:[{text:"个人信息",iconCls:"edit",handler:c.onButtonClickEdit},{text:"退出系统",iconCls:"delete",handler:c.onButtonClickLogout}]});function f(k){alert(k.text)}e.add([{xtype:"tbfill"},{minWidth:120,itemId:"userName",style:{background:"rgb(0, 79, 106)",border:"none"},text:'<span style="color: white">'+globalUserInfo.user_name+"</span>",menu:g}]);$(".x-img-default").on("click",function(){var k=this;$(".x-img-default").each(function(l){if(k==this){a.items.get(l).expand()}})})}})},onTreepanelSelect:function(e,d,f,j){var a=this.getMainPanel(),h=d.get("text"),c=d.raw.className,i=d.get("iconCls"),g=d.get("id");var b=School.util.AddTab.addTab(a,h,c,i,g);School.util.AuthUtil.doBtnPermission(g,b)},onTreepanelItemClick:function(b,a,f,d,e,c){this.onTreepanelSelect(b,a,d,c)},onButtonClickLogout:function(){Ext.Ajax.request({url:zyHost+"user/logout.action",success:function(e,b,c,d){var a=School.util.Util.decodeJSON(e.responseText,true);if(a.success){window.location.reload()}else{School.util.Util.showErrorMsg("退出失败！")}},failure:function(d,a,b,c){School.util.Util.showErrorMsg("连接服务器失败！")}})},onButtonClickEdit:function(){Ext.create("School.view.User").show()}});Ext.define("School.controller.User",{extend:"Ext.app.Controller",requires:["School.model.school.User"],views:["User"],init:function(a){var b=this;this.control({"user #userinfo":{render:function(c){b.getUserInfo(c)}},"user #userinfo #saveInfo":{click:function(c){var d=c.up("form");if(!d.getForm().isValid()){School.util.Util.showErrorMsg("姓名不能为空！");return 0}console.log(d.getForm().getValues());b.updateUserInfo(c.up("window"),d.getForm().getValues())}},"user #userpass #savePass":{click:function(d){var e=d.up("form"),c=e.getForm().getValues(),f=d.up("window");if(!e.getForm().isValid()){School.util.Util.showErrorMsg("密码不能为空！");return 0}if(c.newPassword!==c.newPasswordCfm){School.util.Util.showErrorMsg("两次密码不一致！");return 0}console.log(c);b.checkPassWord(c,f)}},"user #userpic":{render:function(c){c.add([{xtype:"image",itemId:"oldpic",width:180,height:200,src:c.up("window").datas.picUrl,margin:"0 40"},{xtype:"filefield",itemId:"newpic",name:"pic",fieldLabel:"新头像",labelWidth:50,allowBlank:false,msgTarget:"under",anchor:"100%",buttonText:"选择图片..."}]);console.log(c.up("window").datas.picUrl)}},"user #userpic #savePic":{click:function(c){var e=c.up("form").down("#newpic").getValue(),d="jpeg, .jpg, .png, .gif";if(d.indexOf(e.substr(length-4,5).toLowerCase())===-1){School.util.Util.showErrorMsg("你选择的图片格式不正确！");return 0}b.updatePic(c.up("form"))}}})},getUserInfo:function(a){Ext.Ajax.request({url:zyHost+"user/getUserInfo.action",timeout:60000,success:function(g,d,e,f){var b=School.util.Util.decodeJSON(g.responseText).teacherInfo,c;console.log(b);c=School.model.school.User.create(b);a.loadRecord(c);a.down("#sex").setValue({sex:b.sex});a.up("window").datas=b},failure:function(e,b,c,d){School.util.Util.showErrorMsg("链接服务器失败！")}})},updateUserInfo:function(a,b){Ext.Ajax.request({url:zyHost+"user/updateUserInfo.action",timeout:60000,params:b,success:function(g,d,e,f){var c=School.util.Util.decodeJSON(g.responseText);a.close();Ext.ComponentQuery.query("#userName")[0].setText('<span style="color: white">'+b.name+"</span>");c.success&&School.util.Util.showSuccessMsg("修改成功！")},failure:function(f,c,d,e){School.util.Util.showErrorMsg("链接服务器失败！")}})},checkPassWord:function(a,c){var b=this;Ext.Ajax.request({url:zyHost+"sch/judgePassword.action",timeout:60000,params:{password:a.password},success:function(h,e,f,g){var d=School.util.Util.decodeJSON(h.responseText);if(!d.success){School.util.Util.showErrorMsg("您输入的旧密码不正确！无法修改密码！");return 0}var i=c.datas;i.password=a.newPassword;b.updateUserInfo(c,i)},failure:function(g,d,e,f){School.util.Util.showErrorMsg("链接服务器失败！")}})},updatePic:function(a){var b=a.getForm();b.submit({url:zyHost+"contact/updatePic.action",method:"post",waitMsg:"正在上传...",success:function(c,d){School.util.Util.showSuccessMsg("头像上传成功！");a.up("window").close()},failure:function(){School.util.Util.showSuccessMsg("头像上传成功！");a.up("window").close()}})}});Ext.define("School.controller.area.AreaMgr",{extend:"Ext.app.Controller",views:["area.AreaMgr","area.SelectSchool"],init:function(a){this.control({"combo#province":{render:this.onProvinceRender,change:this.onProvinceChange},"combo#city":{change:this.onCityChange},"combo#town":{change:this.onTownChange},"areamgr actioncolumn#readHotNews":{itemclick:this.readHotNews},"publishnews selectschool":{selectionchange:this.onSelectSchoolChange}})},onProvinceRender:function(d){var b=d.getStore(),c="area/findArea.action",a="areas",e={parentId:"0",leave:"1"};b.setProxy(School.util.Util.setProxy(c,e,a))},onProvinceChange:function(f,g,d,e){this.emptySelectedSchools(f);f.up("grid").getStore().reload({params:{id:g,leave:1}});var b=f.up("toolbar").down("combo#city").getStore(),c="area/findArea.action",a="areas",h={parentId:g,leave:"2"};b.setProxy(School.util.Util.setProxy(c,h,a));b.reload()},onCityChange:function(f,g,d,e){this.emptySelectedSchools(f);f.up("grid").getStore().reload({params:{id:g,leave:2}});var b=f.up("toolbar").down("combo#town").getStore(),c="area/findArea.action",a="areas",h={parentId:g,leave:"3"};b.setProxy(School.util.Util.setProxy(c,h,a));b.reload()},onTownChange:function(c,d,a,b){this.emptySelectedSchools(c);c.up("grid").getStore().reload({params:{id:d,leave:3}})},readHotNews:function(a,g,i){var b=a.getStore().getAt(g).get("id"),d=Ext.ComponentQuery.query("mainpanel")[0],c=d.getActiveTab(),h="教育热讯列表",f="newsmgr",e=School.util.AddTab.addTab(d,h,f,"","hotnewslist");School.util.AuthUtil.doBtnPermission(c.getItemId(),e);if(e){e.getStore().reload({params:{type:"teaching",schoolId:b}})}},onSelectSchoolChange:function(d,c,b){var a=[];zy_selectedSchools=[];Ext.each(c,function(e){zy_selectedSchools.push(e.get("id"));a.push(e.get("name"))});Ext.ComponentQuery.query("#publishnews textfield")[0].setValue(a.join("; "))},emptySelectedSchools:function(b){var a=b.up("publishnews");if(a){a.down("#selectedschools").setValue("");zy_selectedSchools=[]}}});Ext.define("School.controller.area.SchoolMgr",{extend:"Ext.app.Controller",views:["area.SchoolMgr"],refs:[{ref:"schoolMgr",selector:"schoolmgr"}],init:function(){this.control({schoolmgr:{afterrender:function(a){a.getStore().reload()}},"schoolmgr toolbar button#add":{click:function(a){Ext.create("School.view.area.AddSchool",{autoShow:true,itemId:"add"})}},"schoolmgr toolbar button#edit":{click:function(b){var c="School.view.area.AddSchool",e="编辑学校",d="请选择需要编辑的学校",a=b.up("gridpanel");School.util.Util.createEditWin(a,c,e,d)}},"addschool form button#save":{click:function(f,g,j){var a,d,c="文件类型不对!只支持jpeg,jpg,png,gif格式的图片",i=Ext.ComponentQuery.query("schoolmgr")[0].getStore(),h="jpeg .jpg .png .gif",b=f.up("form");if(!b.getForm().isValid()){School.util.Util.showErrorMsg("请正确填好表单！");return 0}d=b.getForm().getValues();if(f.up("addschool").getItemId()==="edit"){a="sch/updateSchool.action"}else{a="sch/schoolSave.action";delete d.id}School.util.Util.uploadFile(f,a,d,c,i,h)}},"schoolmgr toolbar button#delete":{click:function(e){var d=e.up("gridpanel"),b=d.getSelectionModel().getSelection(),a=d.getStore(),c="sch/deleteSchool.action",f={};if(b.length===0){School.util.Util.showWarningMsg("请选择一个要删除的学校！");return}f={id:b[0].get("id")};School.util.Util.confirm("删除学校",function(g){if(g!=="yes"){return}School.util.Update.onDeleteButtonClick(a,c,f)})}},"schoolmgr actioncolumn#introduce":{itemclick:function(c,d,b){var a=c.getStore().getAt(d).get("id");if(zy_openWin){zy_openWin.close()}zy_openWin=window.open(zyHost+"article/getIntroduction.action?schoolId="+a,"校园简介")}},"schoolmgr actioncolumn#addManager":{itemclick:function(c,d,b){var a=c.getStore().getAt(d).get("id");Ext.create("School.view.teacher.AddTeacher",{isAuthc:"是",schoolId:a,itemId:"add"}).show()}}})}});Ext.define("School.controller.course.CourseMgr",{extend:"Ext.app.Controller",views:["school.CourseMgr","school.CurriculaMgr"],init:function(a){this.control({coursemgr:{afterrender:function(b){b.getStore().reload()}},"coursemgr toolbar button#add":{click:function(b){School.util.SchoolGlobal.onAddButtonClick(b,"AddCourse","add")}},"coursemgr toolbar button#edit":{click:function(c){var e="AddCourse",i="编辑学科",h="请选择需要编辑的学科",d="edit",b=c.up("gridpanel");School.util.SchoolGlobal.onEditButtonClick(c,b,e,i,h,d);var f=Ext.ComponentQuery.query("addcourse")[0];var g=b.getSelectionModel().getSelection()[0].get("trunk")?"1":"0";f.down("#trunk").setValue({trunk:g})}},"addcourse form button#save":{click:function(f,g,d){var c=School.util.SchoolGlobal.beforeSave(f,"coursemgr"),b="";if(f.up("addcourse").getItemId()==="edit"){b="subject/updateSubject.action"}else{delete c.formValues.id;c.formValues.tScSchoolId=zy_schoolId;b="subject/createSubject.action"}console.log(c.formValues);if(School.util.SchoolGlobal.checkFormValue(c.formPanel)){School.util.Update.onSaveButtonClick(c.win,b,c.store,c.formValues)}}},"coursemgr toolbar button#delete":{click:function(f){var e=f.up("gridpanel"),c=e.getSelectionModel().getSelection(),b=e.getStore(),d="subject/delectSubject.action",g={};if(c.length===0){School.util.Util.showWarningMsg("请选择一个要删除的学科！");return}g={subjectId:c[0].get("id")};School.util.Util.confirm("删除学科",function(h){if(h!=="yes"){return}School.util.Update.onDeleteButtonClick(b,d,g)})}},"coursemgr actioncolumn":{itemclick:function(b,h,j){var f={},g=b.getStore().getAt(h).get("name"),d=Ext.ComponentQuery.query("mainpanel")[0],i="课程管理",e="curriculamgr";zy_subjectRec=b.getStore();f=zy_subjectRec.getAt(h);zy_subjectId=f.get("id");School.util.AddTab.addTab(d,i,e);var c=Ext.ComponentQuery.query("curriculamgr")[0];if(c){c.getStore().reload({params:{subjectId:zy_subjectId},callback:function(){c.down("label#courseName").setText(f.get("name"))}});c.down("#curriculacombo").getStore().reload({callback:function(){c.down("#curriculacombo").setValue(zy_subjectId)}})}}}})}});Ext.define("School.controller.course.CurriculaMgr",{extend:"Ext.app.Controller",views:["school.CourseMgr","school.CurriculaMgr"],init:function(a){this.control({"curriculamgr toolbar button#add":{click:function(c){var b=c.up("gridpanel").down("#curriculacombo");if(!b.getValue()){School.util.Util.showWarningMsg("请选择一个新建课程的所属科目!");return}zy_subjectId=b.getValue();School.util.SchoolGlobal.onAddButtonClick(c,"AddCurricula","add")}},"curriculamgr toolbar button#edit":{click:function(c){var e="AddCurricula",g="编辑课程",f="请选择需要编辑的课程",d="edit",b=c.up("gridpanel");School.util.SchoolGlobal.onEditButtonClick(c,b,e,g,f,d)}},"addcuricula form button#save":{click:function(f,g,d){var c=School.util.SchoolGlobal.beforeSave(f,"curriculamgr"),b="";if(f.up("addcuricula").getItemId()==="edit"){delete c.formValues.tScSubjectId;console.log(c.formValues);b="curricula/updateCurricula.action"}else{delete c.formValues.id;c.formValues.tScSubjectId=zy_subjectId;b="curricula/createCurricula.action"}console.log(c.formValues);if(School.util.SchoolGlobal.checkFormValue(c.formPanel)){School.util.Update.onSaveButtonClick(c.win,b,c.store,c.formValues)}}},"curriculamgr toolbar button#delete":{click:function(f){var e=f.up("gridpanel"),c=e.getSelectionModel().getSelection(),b=e.getStore(),d="curricula/delectCurricula.action",g={};if(c.length===0){School.util.Util.showWarningMsg("请选择一个要删除的课程！");return}g={curriculaId:c[0].get("id")};School.util.Util.confirm("删除课程",function(h){if(h!=="yes"){return}School.util.Update.onDeleteButtonClick(b,d,g)})}},"curriculamgr toolbar combobox#curriculacombo":{change:function(e,d,b,c){zy_subjectId=d;Ext.ComponentQuery.query("curriculamgr")[0].getStore().reload({params:{subjectId:zy_subjectId},callback:function(){e.up("curriculamgr").down("label#courseName").setText(e.getRawValue())}})}}})}});Ext.define("School.controller.course.SelectCurricula",{extend:"Ext.app.Controller",views:["school.SelectCurricula","school.ShowSelectedCurricula"],init:function(a){this.control({"selectcurricula button#queryCurricula":{click:function(d){var c=d.up("gridpanel"),g="",b="",i={},h=c.down("combobox#gradecombo"),f=c.down("combobox#subjectcombo"),e=c.down("combobox#termcombo");if(!f.getValue()){School.util.Util.showErrorMsg('"学科选择"没有选中任何值！');return}if(!h.getValue()){School.util.Util.showErrorMsg('"年级选择"没有选中任何值！');return}if(!e.getValue()){School.util.Util.showErrorMsg('"学期选择"没有选中任何值！');return}zy_gradeRec=h.getStore();zy_gradeId=h.getValue();zy_subjectRec=f.getStore();zy_subjectId=f.getValue();zy_curriculaTeacher=[];g=e.getValue();b=School.util.SchoolGlobal.getNameById(zy_gradeId,zy_gradeRec);i={subjectId:zy_subjectId,adaptiveGrade:b,adaptiveTerm:g,gradeId:zy_gradeId};Ext.Ajax.request({url:zyHost+"curricula/chooseCurricula.action",method:"POST",timeout:60000,params:i,callback:function(l,m,k){if(School.util.Util.decodeJSON(k.responseText).success){var j=School.util.Util.decodeJSON(k.responseText);if(j.curriculas.length===0){zy_chooseCurricula="";zy_curriculaId="";c.down("label#curriculaname").setText("无符合条件的课程");School.util.Util.showErrorMsg("没有符合的课程，请重新选择！");c.getStore().removeAll();return}zy_chooseCurricula=j.curriculas[0];zy_curriculaId=zy_chooseCurricula.id;c.down("label#curriculaname").setText(zy_chooseCurricula.name);c.getStore().reload({params:i,callback:function(n,o,p){if(p){setTimeout(function(){var r=Ext.ComponentQuery.query("selectcurricula #selectTeacher");for(var q=0;q<r.length;q++){r[q].on("change",function(u,v,s,t){School.util.SchoolGlobal.onTeacherChange(u,v,s,t)})}},100)}else{School.util.Util.showErrorMsg("连接服务器失败！")}}})}else{School.util.Util.showSuccessMsg("查询课程失败！")}}})}},"selectcurricula button#save":{click:function(g){console.log(zy_curriculaTeacher);if(!zy_curriculaId){School.util.Util.showErrorMsg("没有符合条件的课程，无法保存，请重新选择！");return}var f=g.up("grid"),h=f.getStore(),e=f.down("combo#termcombo").getStore(),b=f.down("combo#termcombo").getValue(),d=School.util.SchoolGlobal.getNameById(b,e,"name","id");for(var c=0;c<zy_curriculaTeacher.length;c++){Ext.Ajax.request({url:zyHost+"curricula/saveCurriculaVariable.action",method:"POST",timeout:60000,params:{tScCurriculaId:zy_curriculaId,tScClassId:zy_curriculaTeacher[c].classId,tScSemesterId:d,tScTeacherId:zy_curriculaTeacher[c].teacherId},callback:function(j,k,i){if(School.util.Util.decodeJSON(i.responseText).success){f.getStore().reload();zy_curriculaTeacher=[];School.util.Util.showSuccessMsg("保存成功！")}else{School.util.Util.showSuccessMsg("保存失败！")}}})}}},"showselectedcurricula combobox":{change:function(b,c){School.util.SchoolGlobal.showSelectedCurricula(b,c,"showselectedcurricula")}},"showselectedcurricula button#addSelect":{click:function(b){var c=Ext.ComponentQuery.query("mainpanel")[0];School.util.AddTab.addTab(c,"新增选课","selectcurricula")}},"showselectedcurricula button#deleteSelect":{click:function(e){var d=e.up("showselectedcurricula"),c=d.getSelectionModel().getSelection(),b=d.getStore(),h="删除选课",f="curricula/deleteCurriculaVariable.action",g={};if(c.length===0){School.util.Util.showErrorMsg("您没有选择任何课程，无法删除！");return}School.util.Util.confirm("删除选课",function(k){if(k!=="yes"){return}for(var j=0;j<c.length;j++){g={curriculaVariableId:c[j].get("id")};console.log(c[j].get("id"));School.util.Update.onDeleteButtonClick(b,f,g)}})}},"showselectedcurricula button#addExam":{click:function(d){var c=d.up("grid"),b=c.getSelectionModel().getSelection(),e=b.length;if(e===0){School.util.Util.showErrorMsg("您没有选择任何课程，无法开设考试！");return}Ext.create("School.view.exam.AddExam",{extraParams:{records:b}}).show()}},"showselectedcurricula button#reset":{click:function(c){var d=Ext.ComponentQuery.query("showselectedcurricula combo");for(var b=0;b<d.length;b++){d[b].reset()}}}})}});Ext.define("School.controller.school.GradeMgr",{extend:"Ext.app.Controller",views:["school.GradeMgr"],init:function(a){this.control({grademgr:{afterrender:function(b){b.getStore().reload()}},"grademgr toolbar button#add":{click:function(b){School.util.SchoolGlobal.onAddButtonClick(b,"AddGrade","add")}},"grademgr toolbar button#edit":{click:function(c){var e="AddGrade",g="编辑年级",f="请选择需要编辑的年级",d="edit",b=c.up("gridpanel");School.util.SchoolGlobal.onEditButtonClick(c,b,e,g,f,d)}},"addgrade form button#save":{click:function(f,g,d){var c=School.util.SchoolGlobal.beforeSave(f,"grademgr"),b="";c.formValues.teacherId=c.formValues.gradeTeacher;if(f.up("addgrade").getItemId()==="edit"){b="grade/updateGrade.action"}else{delete c.formValues.id;c.formValues.tScSchoolId=zy_schoolId;b="grade/createGrade.action"}console.log(c.formValues);if(School.util.SchoolGlobal.checkFormValue(c.formPanel)){School.util.Update.onSaveButtonClick(c.win,b,c.store,c.formValues)}}},"grademgr toolbar button#delete":{click:function(f){var e=f.up("gridpanel"),c=e.getSelectionModel().getSelection(),b=e.getStore(),d="grade/deleteGrade.action",g={};if(c.length===0){School.util.Util.showWarningMsg("请选择一个要删除的年级！");return}g={id:c[0].get("id")};School.util.Util.confirm("删除年级",function(h){if(h!=="yes"){return}School.util.Update.onDeleteButtonClick(b,d,g)})}},"grademgr toolbar combobox#gradecombo":{change:function(e,d,b,c){zy_schoolId=d;Ext.ComponentQuery.query("grademgr")[0].getStore().reload({params:{schoolId:zy_schoolId}})}},"grademgr actioncolumn":{itemclick:function(b,h,j){var f={},c=b.getStore().getAt(h).get("name"),d=Ext.ComponentQuery.query("mainpanel")[0],i="班级管理",e="classmgr";zy_gradeRec=b.getStore();f=zy_gradeRec.getAt(h);zy_gradeId=f.get("id");School.util.AddTab.addTab(d,i,e);var g=Ext.ComponentQuery.query("classmgr")[0];if(g){g.down("#classcombo").getStore().reload({callback:function(){g.down("#classcombo").setValue(zy_gradeId)}});g.getStore().reload({params:{gradeId:zy_gradeId},callback:function(){g.down("label#gradeName").setText(c)}})}}}})}});Ext.define("School.controller.school.ClassMgr",{extend:"Ext.app.Controller",views:["school.ClassMgr"],init:function(a){this.control({"classmgr toolbar button#add":{click:function(b){School.util.SchoolGlobal.onAddButtonClick(b,"AddClass","add")}},"classmgr toolbar button#edit":{click:function(c){var e="AddClass",g="编辑班级",f="请选择需要编辑的班级",d="edit",b=c.up("gridpanel");School.util.SchoolGlobal.onEditButtonClick(c,b,e,g,f,d)}},"addclass form button#save":{click:function(f,g,d){var c=School.util.SchoolGlobal.beforeSave(f,"classmgr"),b="";c.formValues.teacherId=c.formValues.headTeacher;delete c.formValues.headTeacher;if(f.up("addclass").getItemId()==="edit"){b="clazz/updateClazz.action"}else{delete c.formValues.id;c.formValues.tScGradeId=zy_gradeId;b="clazz/createClazz.action"}console.log(c.formValues);if(School.util.SchoolGlobal.checkFormValue(c.formPanel)){School.util.Update.onSaveButtonClick(c.win,b,c.store,c.formValues)}}},"classmgr toolbar button#delete":{click:function(f){var e=f.up("gridpanel"),c=e.getSelectionModel().getSelection(),b=e.getStore(),d="clazz/deleteClazz.action",g={};if(c.length===0){School.util.Util.showWarningMsg("请选择一个要删除的班级！");return}g={id:c[0].get("id")};School.util.Util.confirm("删除班级",function(h){if(h!=="yes"){return}School.util.Update.onDeleteButtonClick(b,d,g)})}},"classmgr toolbar combobox#classcombo":{change:function(e,d,b,c){zy_gradeId=d;Ext.ComponentQuery.query("classmgr")[0].getStore().reload({params:{gradeId:zy_gradeId}})}}})}});Ext.define("School.controller.clazz.MyClass",{extend:"Ext.app.Controller",views:["school.MyClass","clazz.PostMgr"],init:function(a){this.control({myclass:{afterrender:function(b){b.down("combobox#myclasses").setValue(zy_classId)}},"myclass toolbar button#edit":{click:function(c){var e="AddStudent",g="编辑学生信息",f="请选择需要编辑的学生",d="edit",b=c.up("gridpanel");School.util.SchoolGlobal.onEditButtonClick(c,b,e,g,f,d)}},"addstudent button#save":{click:function(f,g,d){var c=School.util.SchoolGlobal.beforeSave(f,"myclass"),b="";if(f.up("addstudent").getItemId()==="edit"){b="student/updateStudentInfo.action"}else{return}console.log(c.formValues);if(School.util.SchoolGlobal.checkFormValue(c.formPanel)){School.util.Update.onSaveButtonClick(c.win,b,c.store,c.formValues)}}},"myclass combobox#myclasses":{change:function(f,e,c,d){f.up("myclass").down("label#className").setText(f.getRawValue());var b=document.getElementById("mycourseSchedule");if(document.getElementById("mycourseSchedule")){b.contentWindow.getCurricula(e)}f.up("myclass").getStore().reload({params:{clazzId:e},callback:function(g,h,i){if(!i){School.util.Util.showErrorMsg("获取数据失败!");return}}})}},"myclass toolbar button#download":{click:function(d){var b="",c=d.up("myclass").down("#myclasses").getValue();console.log(c);b+='<input type="text" name="clazzId" value="'+c+'"/>';School.util.Util.downloadFile("student/downloadStudentAndParentExcel.action",b)}},"myclass toolbar button#upload":{click:function(b){Ext.create("School.view.school.UploadStudent").show()}},"uploadstudent button#save":{click:function(e){var c="student/saveStudentAndParent.action",d=Ext.ComponentQuery.query("myclass")[0],h="该文件类型不是excel文件，请重新选择！",f=d.down("combobox#myclasses").getValue(),b=d.getStore(),g={file:e.up("form").down("filefield").getValue(),clazzId:f};School.util.Util.uploadFile(e,c,g,h,b)}},"myclass button#viewSyllabus":{click:function(c){var b=Ext.ComponentQuery.query("syllabus")[0];b&&b.destroy();var d=Ext.ComponentQuery.query("mainpanel")[0],f="我的课表",g="syllabus",e=c.up("myclass").down("#myclasses").getValue();School.util.AddTab.addTab(d,f,g,"",e)}},"myclass button#viewPost":{click:function(b){var c=Ext.ComponentQuery.query("postmgr")[0];c&&c.destroy();var d=Ext.ComponentQuery.query("mainpanel")[0],f="班级帖子",g="postmgr",e=b.up("myclass").down("#myclasses").getValue();School.util.AddTab.addTab(d,f,g,"","postmgr")}},"myclass actioncolumn":{itemclick:function(e,i,d){var c=e.getStore(),b=c.getAt(i).get("studentId"),h=c.getAt(i).get("parentId"),f="student/deleteStudent.action",g={studentId:b,parentId:h};School.util.Util.confirm("删除学生",function(j){if(j==="yes"){School.util.Update.onDeleteButtonClick(c,f,g)}})}}})}});Ext.define("School.controller.clazz.PostMgr",{extend:"Ext.app.Controller",views:["clazz.PostMgr"],init:function(a){var b=this;this.control({postmgr:{render:function(c){c.getStore().load()}},"postmgr #viewpost":{itemclick:function(c,i,l){var m=c.getStore().getAt(i),j=m.get("title"),d=m.get("context"),k=m.get("createTime"),e=m.get("praisesCount"),h=m.get("repliesCount"),f=m.get("publisherName"),g=m.get("urls");console.log(m.get("title"));Ext.create("School.view.clazz.ViewPost");setTimeout(function(){var q=document.getElementById("postWin").contentWindow,p=q.$;p(".user-value").text(f);p(".title-value").text(j||"无");p(".time-value").text(k);p(".context-value").text(d);p(".comment-value").text("("+(h||0)+")");p(".praise-value").text("("+(e||0)+")");var o=0,n=g.length;for(o=0;o<n;o++){p(".images").append('<div class="col-xs-4"><img src="'+g[o]+'" class="img-responsive" /></div>')}},1000)}},"postmgr #deletepost":{itemclick:function(g,j,e){var d=g.getStore(),f=d.getAt(j),c=f.get("id"),h="post/deletePost.action",i={postId:c};School.util.Util.confirm("删除新闻",function(k){if(k==="yes"){console.log(i);School.util.Update.onDeleteButtonClick(d,h,i)}})}}})}});Ext.define("School.controller.clazz.Syllabus",{extend:"Ext.app.Controller",views:["school.Syllabus"],init:function(a){var b=this;this.control({syllabus:{render:function(c){setTimeout(function(){b.refreshSyllabus(c.getItemId())},1000)}},"syllabus button#upload":{click:function(){var c=Ext.create("School.view.school.UploadSyllabus");c.show()}},"uploadsyllabus button#save":{click:function(g){var m=g.up("window").down("#termcombo"),e=g.up("form").down("filefield");if(!m.getValue()||!e.getValue()){School.util.Util.showErrorMsg('"适用学期"和"文件选择"不能为空');return 0}var l=Ext.ComponentQuery.query("syllabus")[0],j=l.getItemId(),c="curricula/uploadCurriculaExcel.action",d="该文件类型不是excel文件，请重新选择！",k="",i=".xls",f={file:e.getValue(),clazzId:j,semesterId:m.getValue()};console.log(f);School.util.Util.uploadFile(g,c,f,d,k,i,h);function h(){b.refreshSyllabus(j)}}},"syllabus button#download":{click:function(){var c="",d=Ext.ComponentQuery.query("myclass")[0].down("combobox#myclasses").getValue();c+='<input type="text" name="clazzId" value="'+d+'"/>';School.util.Util.downloadFile("curricula/downloadCurricula.action",c)}}})},refreshSyllabus:function(a){Ext.Ajax.request({url:zyHost+"curricula/getCurricula.action",timeout:60000,params:{clazzId:a},success:function(c,d,l,g){var m=School.util.Util.decodeJSON(c.responseText);if(m.success){var k=m.result,b=k.length,j,h,f=document.getElementById("mycourseSchedule").contentWindow.$;for(var e=1;e<=9;e++){f(".section"+e).hide()}f("div[class*=week]").html("-");console.log(f("div[class*=week]").length);for(var e=0;e<b;e++){j=".section"+k[e].section;h=j+" .week"+k[e].week;f(j).show();f(h).html(k[e].name)}f(".comment").html(d.comment)}else{School.util.Util.showErrorMsg("获取课程表失败！")}},failure:function(e,b,c,d){School.util.Util.showErrorMsg("链接服务器失败！")}})}});Ext.define("School.controller.teacher.DepartMgr",{extend:"Ext.app.Controller",views:["school.DepartMgr"],init:function(a){this.control({departmgr:{afterrender:function(b){b.getStore().reload()}},"departmgr toolbar button#add":{click:function(b){Ext.create("School.view.teacher.AddDepart",{itemId:"add"})}},"departmgr toolbar button#edit":{click:function(c){var b,d;b=c.up("gridpanel").getSelectionModel().getSelection()[0];if(!b){School.util.Util.showWarningMsg("请选择需要编辑的部门！");return 0}d=Ext.create("School.view.teacher.AddDepart",{title:"编辑部门",itemId:"edit"});d.down("form").loadRecord(b)}},"adddepart form button#save":{click:function(g,j,d){var i=g.up("adddepart"),f=Ext.ComponentQuery.query("departmgr")[0],h=g.up("form").getForm().getValues(),b=f?f.getStore():null,c="";if(!i.down("form").getForm().isValid()){School.util.Util.showWarningMsg("请正确填好表单！");return 0}h.tScSchoolId=zy_schoolId;c=i.getItemId()==="edit"?"department/updateDepartment.action":"department/createDepartment.action";School.util.Update.onSaveButtonClick(i,c,b,h)}},"departmgr toolbar button#delete":{click:function(f){var e=f.up("gridpanel"),c=e.getSelectionModel().getSelection(),b=e.getStore(),d="department/deleteDepartment.action",g={};if(c.length===0){School.util.Util.showWarningMsg("请选择一个要删除的部门！");return}g={id:c[0].get("id")};School.util.Util.confirm("删除部门",function(h){if(h!=="yes"){return}School.util.Update.onDeleteButtonClick(b,d,g)})}},"departmgr actioncolumn#edit":{itemclick:function(f,j,c){var h=[],e=f.getStore().getAt(j).get("name"),b=f.getStore().getAt(j).get("id"),g=f.getStore().getAt(j).get("teachers");for(var d=0;d<g.length;d++){h.push(g[d].id)}Ext.create("School.view.teacher.DepartStaff",{title:"编辑部门人员("+e+")",datas:{grid:f,rowIndex:j,colIndex:c,teachersId:h.join(","),departId:b}})}},"departstaff #allNotDept":{change:function(b,c){c?this.selectAll(".teachers .others input[type=checkbox]"):this.deSelectAll(".teachers .others input[type=checkbox]")}},"departstaff #allDept":{change:function(b,c){c?this.selectAll(".teachers .staffs input[type=checkbox]"):this.deSelectAll(".teachers .staffs input[type=checkbox]")}},"departstaff button#add":{click:function(c){var b=".teachers .others input[type=checkbox]",d=1;this.saveStaff(c,b,d)}},"departstaff button#delete":{click:function(c){var b=".teachers .staffs input[type=checkbox]",d=2;this.saveStaff(c,b,d)}},"window dataview":{afterrender:function(b){b.getStore().reload()}}})},selectAll:function(a){$(a).each(function(){this.checked=true})},deSelectAll:function(a){$(a).each(function(){this.checked=false})},saveStaff:function(e,b,j){var f=e.up("#departstaff").datas,a=[],h=0;$(b).each(function(){if(this.checked===true){a.push(this.id)}});var c={option:j,departmentId:f.departId};if(a.length===0){School.util.Util.showErrorMsg("您没有选中任何教师，无法提交!");return 0}for(var d=0,g=a.length;d<g;d++){c.teacherId=a[d];Ext.Ajax.request({url:zyHost+"department/assignTeacherToDepartment.action",method:"POST",timeout:60000,params:c,callback:function(k,l,i){h++;if(h===a.length){Ext.ComponentQuery.query("departmgr")[0].getStore().reload({callback:function(){e.up("departstaff").close();Ext.ComponentQuery.query("departmgr actioncolumn#edit")[0].fireEvent("itemclick",f.grid,f.rowIndex,f.colIndex)}})}}})}}});Ext.define("School.controller.exam.ExamMgr",{extend:"Ext.app.Controller",views:["exam.ExamMgr"],init:function(a){this.control({"exammgr button#reset":{click:function(c){var d=Ext.ComponentQuery.query("exammgr combo");for(var b=0;b<d.length;b++){d[b].reset()}}},"exammgr combobox":{change:function(b,c){School.util.SchoolGlobal.showSelectedCurricula(b,c,"exammgr")}},"addexam form button#save":{click:function(g){var h=g.up("addexam"),d=g.up("addexam").down("form").getValues(),c=Ext.ComponentQuery.query("showselectedcurricula")[0].getStore(),b=h.extraParams.records,e="exam/createExam.action";if(School.util.SchoolGlobal.checkFormValue(h.down("form"))){for(var f=0;f<b.length;f++){d.curriculaVariableId=b[f].get("id");School.util.Update.onSaveButtonClick(h,e,c,d,'您可以到"考试&成绩"面板里查看考试详情')}}}},"exammgr toolbar button#edit":{click:function(c){var b=c.up("grid").getSelectionModel().getSelection(),d;if(!b[0]){School.util.Util.showErrorMsg("您没有选择任何考试，无法编辑！");return 0}d=Ext.create("School.view.exam.EditExam",{itemId:"edit",title:"编辑考试"});d.down("form").loadRecord(b[0]);d.show()}},"editexam form button#save":{click:function(f,g,d){var c=School.util.SchoolGlobal.beforeSave(f,"exammgr"),b="exam/updateExam.action";console.log(c.formValues);if(School.util.SchoolGlobal.checkFormValue(c.formPanel)){School.util.Update.onSaveButtonClick(c.win,b,c.store,c.formValues)}}},"exammgr toolbar button#delete":{click:function(f){var e=f.up("gridpanel"),c=e.getSelectionModel().getSelection(),b=e.getStore(),d="exam/deleteExam.action",g={};if(c.length===0){School.util.Util.showWarningMsg("请选择一个要删除的考试！");return}g={id:c[0].get("id")};School.util.Util.confirm("删除考试",function(h){if(h!=="yes"){return}School.util.Update.onDeleteButtonClick(b,d,g)})}},"exammgr actioncolumn":{itemclick:function(c,h,b){zy_examRec=c.getStore().getAt(h);zy_examId=c.getStore().getAt(h).get("id");var d=Ext.ComponentQuery.query("mainpanel")[0],f="成绩管理",g="scoremgr";School.util.AddTab.addTab(d,f,g);var e=Ext.ComponentQuery.query("scoremgr")[0];if(e){e.getStore().reload({params:{examId:zy_examId},callback:function(){e.down("label#examName").setText(c.getStore().getAt(h).get("name"))}})}}}})}});Ext.define("School.controller.exam.ScoreMgr",{extend:"Ext.app.Controller",views:["exam.ScoreMgr"],init:function(a){this.control({"scoremgr button#downloadScore":{click:function(c){var b="";b+='<input type="text" name="clazzId" value="'+zy_examRec.get("clazzId")+'"/>';b+='<input type="text" name="clazzName" value="'+zy_examRec.get("clazzName")+'"/>';b+='<input type="text" name="examId" value="'+zy_examRec.get("id")+'"/>';b+='<input type="text" name="examName" value="'+zy_examRec.get("name")+'"/>';console.log(b);School.util.Util.downloadFile("score/downClazzScore.action",b)}},"scoremgr button#uploadScore":{click:function(){Ext.create("School.view.exam.UploadScore").show()}},"uploadscore button#save":{click:function(d){var c="score/uploadScore.action",e="该文件类型不是excel文件，请重新选择！",b=Ext.ComponentQuery.query("scoremgr")[0].getStore();params={file:d.up("form").down("filefield").getValue(),examId:zy_examId};School.util.Util.uploadFile(d,c,params,e,b)}},"scoremgr button#delete":{click:function(e){var d=e.up("scoremgr"),b=d.getStore(),c="score/deleteByExamId.action",f={examId:zy_examId};School.util.Util.confirm("删除成绩",function(g){if(g!=="yes"){return}School.util.Update.onDeleteButtonClick(b,c,f)})}}})}});Ext.define("School.controller.multimedia.AlbumMgr",{extend:"Ext.app.Controller",views:["multimedia.AlbumMgr"],init:function(a){var b=this;this.control({albummgr:{afterRender:function(f){var e="album/getAlbumNoPager.action",i,c="albums",g="totalCount",d=f.getStore(),h=f.down("#myclasses");if(f.getItemId()==="schollalbum"){h.hide();i={schoolId:zy_schoolId,type:1};d.setProxy(School.util.Util.setProxy(e,i,c,g));d.load();return 0}i={clazzId:zy_classId,type:1};d.setProxy(School.util.Util.setProxy(e,i,c,g));h.setValue(zy_classId)}},"albummgr#classalbum combobox#myclasses":{change:function(f,e,c,d){f.up("albummgr#classalbum").getStore().reload({params:{clazzId:e,type:1}})}},"albummgr button#addAlbum":{click:function(d){var e,c;c=d.up("albummgr");e={store:c.getStore(),range:c.getItemId()};School.util.MultimediaGlobal.onAddButtonClick(d,"AddAlbum","add",e)}},"albummgr button#deleteAlbum":{click:function(h,j,f){var g=h.up("gridpanel"),c=g.getSelectionModel().getSelection();if(School.util.SchoolGlobal.checkSelectRow(c)){var d=g.getStore(),i=zyHost+"album/deleteAlbum.action",k={albumId:c[0].get("id")};School.util.Util.confirm("删除相册",function(e){if(e==="yes"){School.util.Update.onDeleteButtonClick(d,i,k)}})}}},"addalbum button#save":{click:function(h){if(!h.up("addalbum").down("form").getForm().isValid()){School.util.Util.showErrorMsg("相册名称不可为空或长度不可超出12个字符！");return 0}var j=h.up("addalbum"),g="album/createAlbum.action",e=h.up("addalbum").down("form").getForm().getValues(false),d=j.params.store,c=j.params.range;if(c==="schollalbum"){delete e.clazzId;e.schoolId=zy_schoolId}else{delete e.schoolId;var i=Ext.ComponentQuery.query("albummgr"),f;f=i[0].getItemId()==="schollalbum"?1:0;e.clazzId=i[f].down("#myclasses").getValue()}console.log(e);School.util.Update.onSaveButtonClick(j,g,d,e)}},"albummgr actioncolumn#openAlbum":{itemclick:function(c,k,m){zy_albumId=c.getStore().getAt(k).get("id");var e=Ext.ComponentQuery.query("mainpanel")[0],l="照片管理",g="photomgr",j=c.getStore().getAt(k).get("name");School.util.AddTab.addTab(e,l,g);var f=Ext.ComponentQuery.query("photomgr"),d;for(var h=0;h<f.length;h++){if(f[h].getItemId()!=="viewPager"){d=f[h];break}}if(d){d.down("dataview").getStore().reload({params:{albumId:zy_albumId},callback:function(){d.down("label#albumName").setText(j)}})}}}})}});Ext.define("School.controller.multimedia.PhotoMgr",{extend:"Ext.app.Controller",views:["multimedia.PhotoMgr"],refs:[{ref:"photoMgr",selector:"photomgr"}],init:function(a){var b=this;this.control({photomgr:{afterRender:function(e){var c=e.down("pagingtoolbar").getStore(),f,d="photo/getPassPhoto.action";if(e.getItemId()==="viewPager"){if(zy_viewPagerId){f={albumId:zy_viewPagerId};c.setProxy(School.util.Util.setProxy(d,f,"photos","totalCount"));c.reload({callback:function(){b.PhotoEvents()}});return 0}Ext.Ajax.request({url:zyHost+"album/getAlbumNoPager.action",timeout:60000,params:{schoolId:zy_schoolId,type:0},success:function(k,h,i,j){var g=School.util.Util.decodeJSON(k.responseText);if(g.success){zy_viewPagerId=g.albums[0].id;f={albumId:zy_viewPagerId};c.setProxy(School.util.Util.setProxy(d,f,"photos","totalCount"));c.reload({callback:function(){b.PhotoEvents()}})}},failure:function(j,g,h,i){console.log(g.responseText);School.util.Util.showErrorMsg("链接服务器失败！")}});return 0}f={albumId:zy_albumId};c.setProxy(School.util.Util.setProxy(d,f,"photos","totalCount"));c.reload({callback:function(){b.PhotoEvents()}})}},"photomgr button#uploadPhoto":{click:function(d){var e=d.up("photomgr"),f,c=false;if(e.getItemId()==="viewPager"){c=true;if(e.down("dataview").getStore().getCount()>=5){School.util.Util.showWarningMsg("轮播照片不得多于5张，请删除后再上传");return 0}}f=Ext.create("School.view.multimedia.UploadMultiPhotos",{isViewPager:c,dataView:e.down("dataview")});f.mask("正在初始化上传插件...","loading");setTimeout(function(){b.uploadMultiPhostos(f)},2000)}},"photomgr button#deletePhoto":{click:function(g){var c=$(".selectedPhoto")[0];if(!c){School.util.Util.showErrorMsg("请选择一张要删除的照片！");return 0}var f=g.up("photomgr"),j=g.up("photomgr").getItemId(),e=zyHost+"photo/deletephoto.action",i="删除照片",d=f.store,h={id:c.id};h.tmId=(j==="viewPager"?zy_viewPagerId:zy_albumId);School.util.Util.confirm("删除照片",function(k){if(k==="yes"){School.util.Update.onDeleteButtonClick(d,e,h)}})}}})},PhotoEvents:function(){$("body").on("click",".passed-photolist .passed-photo",function(){$(".selectedPhoto").removeClass("selectedPhoto");$(this).addClass("selectedPhoto")})},uploadMultiPhostos:function(d){d.unmask();var a=document.getElementById("fileUpload").contentWindow,b=a.$,f=0,e=0,i=0,g=0,c=[];function h(){f++;if(f===e){d.dataView.getStore().reload();d.close();School.util.Util.showSuccessMsg("图片上传完成！")}}b("#upload").click(function(){e=c.length;for(var j=0;j<e;j++){c[j].submit()}});b("#fileupload").fileupload({url:"../photo/uploadPhoto.action",dataType:"json",autoUpload:false,type:"post",formData:{files:"files",name:"未命名",tMId:d.isViewPager?zy_viewPagerId:zy_albumId},acceptFileTypes:/(\.|\/)(gif|jpe?g|png)$/i,maxFileSize:5000000,disableImageResize:/Android(?!.*Chrome)|Opera/.test(window.navigator.userAgent),previewMaxWidth:100,previewMaxHeight:100,previewCrop:true}).on("fileuploadadd",function(k,j){j.context=b('<div class="show"/>').appendTo("#files");b.each(j.files,function(l,m){var n=b("<p/>").append(b("<span/>"));if(!l){c.push(j)}n.appendTo(j.context)})}).on("fileuploadprocessalways",function(n,m){var j=m.index,k=m.files[j],l=b(m.context.children()[j]);if(k.preview){l.prepend("<br>").prepend(k.preview)}if(k.error){l.append("<br>").append(b('<span class="text-danger"/>').text(k.error))}if(j+1===m.files.length){m.context.find("button").text("Upload").prop("disabled",!!m.files.error)}}).on("fileuploadprogressall",function(l,k){var j=parseInt(k.loaded/k.total*100,10);b("#progress .progress-bar").css("width",j+"%")}).on("fileuploaddone",function(k,j){h();i++}).on("fileuploadfail",function(k,j){h();g++})}});Ext.define("School.controller.multimedia.LibMgr",{extend:"Ext.app.Controller",views:["multimedia.VideolibMgr","multimedia.VideoMgr"],init:function(a){var b=this;this.control({videolibmgr:{afterRender:function(f){var e="library/getLibrary.action",h,c="librarys",g="totalCount",d=f.getStore();if(f.getItemId()==="schoollib"){f.down("combobox#myclasses").hide();h={schoolId:zy_schoolId};d.setProxy(School.util.Util.setProxy(e,h,c,g));d.load()}else{h={clazzId:zy_classId};d.setProxy(School.util.Util.setProxy(e,h,c,g));f.down("combobox#myclasses").setValue(zy_classId)}}},"videolibmgr#classlib combobox#myclasses":{change:function(f,e,c,d){f.up("videolibmgr#classlib").getStore().reload({params:{clazzId:e}})}},"videolibmgr button#addLib":{click:function(d){var c={itemId:d.up("videolibmgr").getItemId()};School.util.MultimediaGlobal.onAddButtonClick(d,"AddVideolib","add",c)}},"videolibmgr button#editLib":{click:function(e){var c=e.up("gridpanel").getSelectionModel().getSelection();if(c.length===0){School.util.Util.showErrorMsg("请选择一个视频库");return}var g="edit",d=e.up("gridpanel"),f="AddVideolib",i="修改视频库",h="请选择一个视频库",j={itemId:d.getItemId(),libId:c[0].get("id")};School.util.MultimediaGlobal.onEditButtonClick(e,d,f,i,h,g,j)}},"addvideolib button#save":{click:function(f){var g=f.up("addvideolib"),h=Ext.ComponentQuery.query("videolibmgr#"+f.up("window").params.itemId)[0],d=h.getStore(),e="",c=f.up("addvideolib").down("form").getForm().getValues(false);if(School.util.MultimediaGlobal.checkFormValue(g.down("form"))){switch(g.getItemId()){case"add":e="library/createLibrary.action";if(g.params.itemId==="schoollib"){delete c.clazzId;c.schoolId=zy_schoolId}else{delete c.schoolId;c.clazzId=h.down("combobox#myclasses").getValue()}break;default:e="library/updateLibrary.action";c.id=g.params.libId;break}console.log(c);School.util.Update.onSaveButtonClick(g,e,d,c)}}},"videolibmgr button#deleteLib":{click:function(f,h,l){var c=f.up("gridpanel"),g=c.getSelectionModel().getSelection();if(!g.length){School.util.Util.showErrorMsg("请选择一个需要删除的视频库！");return 0}if(g[0].get("photoCount2")){School.util.Util.showErrorMsg("该视频库里有视频文件，无法删除，您可以先把里面的视频删除！");return 0}var k=c.getStore(),j="删除视频库",i="library/deleteLibrary.action",d={libraryId:g[0].get("id")};School.util.Util.confirm("删除视频库",function(e){if(e==="yes"){School.util.Update.onDeleteButtonClick(k,i,d)}})}},"videolibmgr actioncolumn#openVideolib":{itemclick:function(e,j,d){zy_videolibId=e.getStore().getAt(j).get("id");var g=Ext.ComponentQuery.query("mainpanel")[0],h="视频管理",i="videomgr",c=e.getStore().getAt(j).get("name2");School.util.AddTab.addTab(g,h,i);var f=Ext.ComponentQuery.query("videomgr")[0];if(f){f.getStore().reload({callback:function(){f.down("label#libName").setText(c)}})}}}})}});Ext.define("School.controller.multimedia.VideoMgr",{extend:"Ext.app.Controller",views:["multimedia.VideoMgr"],init:function(a){var b=this;this.control({"videomgr button#uploadVideo":{click:function(c){Ext.create("School.view.multimedia.UploadVideo").show()}},"uploadvideo button#save":{click:function(e){var d="video/uploadVideo.action",f=".wmv .flv .mp4 .avi .webm .ogv",h="文件类型不对！只支持.wmv .flv .mp4 .avi .webm .ogv格式的视频，请重新选择！",c=Ext.ComponentQuery.query("videomgr")[0].getStore(),g={file:e.up("form").down("filefield").getValue(),name:e.up("form").down("textfield").getValue,tMId:zy_videolibId};School.util.Util.uploadFile(e,d,g,h,c,f)}},"videomgr button#deleteVideo":{click:function(h,j,f){var g=h.up("gridpanel"),c=g.getSelectionModel().getSelection();if(!c.length){School.util.Util.showErrorMsg("请选择一个需要删除的视频");return 0}var d=g.getStore(),i=zyHost+"video/deleteVideo.action",k={videoId:c[0].get("id"),tMId:zy_videolibId};School.util.Util.confirm("删除视频",function(e){if(e==="yes"){School.util.Update.onDeleteButtonClick(d,i,k)}})}}})}});Ext.define("School.controller.multimedia.CheckPhoto",{extend:"Ext.app.Controller",views:["multimedia.CheckPhoto"],init:function(a){this.control({checkphoto:{afterRender:function(b){b.down("#myclasses").setValue(zy_classId)}},"checkphoto combobox#myclasses":{change:function(f,e,b,c){var d=f.up("checkphoto");d.store.reload({params:{clazzId:e},callback:function(g,h,i){$("body").on("click",".nopass-photolist .nopass-photo",function(){if(!$(this).next(".nopass-tag").length){$(this).after('<img class="nopass-tag" src="resources/images/tick_on.png" id="'+this.id+'"/>')}else{$(this).next(".nopass-tag").remove()}d.down("label#photonum").setText($(".nopass-photolist .nopass-tag").length)})}});Ext.Ajax.request({url:zyHost+"album/getNoPassAlbum.action",method:"POST",timeout:60000,params:{clazzId:e},success:function(h,i){var g=School.util.Util.decodeJSON(h.responseText);if(g.success){zy_noPassAlbumId=g.album.id}else{School.util.Util.showErrorMsg("请求数据失败")}},failure:function(g,h){School.util.Util.showErrorMsg("链接服务器失败！")}})}},"checkphoto button#pass":{click:function(b){var e,d=b.up("checkphoto").down("combobox#myclasses").getValue(),c=[];$(".nopass-photolist .nopass-tag").each(function(){c.push(this.id)});if(c.length===0){School.util.Util.showErrorMsg("您没有选中任何相片，无法通过审核！");return}e=Ext.create("School.view.multimedia.PassCheck",{params:c.join(",")});e.show();e.down("combobox#selectAlbum").getStore().reload({params:{clazzId:d,type:1}})}},"passcheck button#save":{click:function(e){if(!e.up("passcheck").down("combobox#selectAlbum").getValue()){School.util.Util.showErrorMsg("请选择一个相册！");return}var g=e.up("passcheck"),c=zyHost+"photo/updatePhoto.action",d=Ext.ComponentQuery.query("checkphoto")[0],b=d.store,f={clazzId:d.down("combobox#myclasses").getValue()},h={id:g.params,tmId:g.down("combobox#selectAlbum").getValue(),demoId:zy_noPassAlbumId};console.log(h);School.util.Update.onSaveButtonClick(g,c,b,h,".",f);console.log(h)}},"checkphoto button#deletePhoto":{click:function(e){var d=e.up("checkphoto"),c=zyHost+"photo/deletephoto.action",i="删除照片",b=d.store,h={},g={clazzId:d.down("combobox#myclasses").getValue()},f=[];$(".nopass-photolist .nopass-tag").each(function(){f.push(this.id)});if(f.length===0){School.util.Util.showErrorMsg("您没有选中任何相片，无法删除！");return}h.id=f.join(",");h.tmId=zy_noPassAlbumId;console.log(h);School.util.Update.onDeleteButtonClick(b,c,h,g)}},"checkphoto button#editPhoto":{click:function(){var b=[],c={};$(".nopass-photolist .nopass-tag").each(function(){b.push(this.id)});if(b.length===0){School.util.Util.showErrorMsg("您没有选中任何相片，无法修改！");return}c=Ext.create("School.view.multimedia.EditPhoto",{params:b});c.show();console.log("参数为：");console.log(c.params)}},"editphoto button#save":{click:function(j){var k=j.up("editphoto"),d=zyHost+"photo/updateName.action",c=Ext.ComponentQuery.query("checkphoto")[0],l=c.store,g={},e=k.down("#photoName").getValue(),b=k.params,f={clazzId:c.down("combobox#myclasses").getValue()};for(var h=0;h<b.length;h++){g.id=b[h];g.name=e;School.util.Update.onSaveButtonClick(k,d,l,g,".",f)}}},"checkphoto checkbox#selectAll":{change:function(e,d,b,c){$(".nopass-photolist .nopass-tag").remove();if(d){$(".nopass-photolist .nopass-photo").each(function(){$(this).after('<img class="nopass-tag" src="resources/images/tick_on.png" id="'+this.id+'"/>')})}e.up("checkphoto").down("label#photonum").setText($(".nopass-photolist .nopass-tag").length)}}})}});Ext.define("School.controller.school.SchoolSummy",{extend:"Ext.app.Controller",views:["school.SchoolSummy","school.PublishSchoolSummy"],init:function(a){this.control({schoolsummy:{afterRender:function(b){var c=Ext.create("School.store.news.NewsMgr");c.reload({params:{schoolId:zy_schoolId,type:"summy"},callback:function(){if(c.getCount()===0){School.util.util.showErrorMsg("暂时没有学校简介，请到新增学校简介里进行添加！");return}b.add({xtype:"panel",html:"<iframe src= "+zyHost+"article/getArticle.action?articleId="+c.getAt(0).get("id")+"  frameborder=0 width=100% height=100%></iframe>"})}})}},"schoolsummy button#publish":{click:function(b){var c=Ext.ComponentQuery.query("mainpanel")[0],d="新建校园简介",e="publishnews";School.util.AddTab.addTab(c,d,e,"menu_profile","publishschoolsummy")}}})}});Ext.define("School.controller.news.NewsMgr",{extend:"Ext.app.Controller",views:["news.NewsMgr","news.PublishNews","news.ReadNews"],init:function(a){this.control({newsmgr:{afterrender:function(c){var d=c.getItemId();if(d==="schoolnews"){c.down("combo#mygrades").destroy();c.down("combo#newscombo").setValue("news")}else{if(d==="hotnewslist"){c.down("combo#mygrades").destroy();c.down("combo#newscombo").destroy();c.down("button#publish").destroy()}else{c.down("combo#newscombo").destroy();var b=c.down("combo#mygrades");c.gradeStore.reload({callback:function(){b.setValue(c.gradeStore.getAt(0).get("id"))}})}}}},"newsmgr combo#newscombo":{change:function(e,d,b,c){e.up("newsmgr").getStore().reload({params:{schoolId:zy_schoolId,type:d}})}},"newsmgr combo#mygrades":{change:function(e,d,b,c){e.up("newsmgr").getStore().reload({params:{gradeId:d,type:"educate"}})}},"newsmgr actioncolumn#details":{itemclick:function(e,i,d){var b=e.getStore().getAt(i).get("id");var c=Ext.ComponentQuery.query("readnews")[0];if(c){c.close()}var f=Ext.ComponentQuery.query("mainpanel")[0],g="查看新闻",h="readnews";School.util.AddTab.addTab(f,g,h,"",b)}},"newsmgr actioncolumn#copy":{itemclick:function(c,e,b){var d=c.getStore().getAt(e).get("id");Ext.create("School.view.news.CopyNews",{itemId:d})}},"copynews button#save":{click:function(c){var d=[],f=c.up("copynews"),e=f.down("selectschool").getSelectionModel().getSelection();if(!e.length){School.util.Util.showWarningMsg("您没有选择任何学校，无法保存复制！");return 0}for(var b=0;b<e.length;b++){d.push(e[b].get("id"))}console.log(d);Ext.Ajax.request({url:zyHost+"article/copyArticle.action",timeout:60000,params:{articleId:f.getItemId(),zoneId:d.join(","),type:"teaching"},success:function(k,h,i,j){var g=School.util.Util.decodeJSON(k.responseText);if(g.success){f.destroy();School.util.Util.showSuccessMsg("复制成功!")}else{School.util.Util.showErrorMsg("保存失败!")}},failure:function(j,g,h,i){School.util.Util.showErrorMsg("链接服务器失败！")}})}},readnews:{afterrender:function(b){b.add({xtype:"panel",html:"<iframe src= "+zyHost+"article/getArticle.action?articleId="+b.getItemId()+"  frameborder=0 width=100% height=100%></iframe>"})}},"newsmgr actioncolumn#delete":{itemclick:function(e,h,d){var b=e.getStore().getAt(h).get("id"),c=e.getStore(),f="article/deleteArticle.action",g={articleId:b};School.util.Util.confirm("删除新闻",function(i){if(i==="yes"){School.util.Update.onDeleteButtonClick(c,f,g)}})}},"newsmgr button#publish":{click:function(b){var c=Ext.ComponentQuery.query("mainpanel")[0],e,d,f="publishnews";if(b.up("newsmgr").getItemId()==="schoolnews"){e="发布校园新闻";d="publishschoolnews"}else{e="发布年级新闻";d="publishclassnews"}School.util.AddTab.addTab(c,e,f,"menu_profile",d)}}})}});Ext.define("School.controller.news.NewsPublish",{extend:"Ext.app.Controller",views:["news.PublishNews"],init:function(a){this.control({publishnews:{afterrender:function(b){var d=b.down("form"),c='<iframe src="ueditor.html" frameborder=0 width=100% height=100% ';switch(b.getItemId()){case"publishclassnews":c+='id="classNews"></iframe>';d.remove(d.down("#newscombo"));d.remove(d.down("#selectedschools"));break;case"publishschoolnews":c+='id="schoolNews"></iframe>';d.remove(d.down("#selectedschools"));break;case"publishschoolsummy":c+='id="schoolSummy"></iframe>';d.remove(d.down("#title"));d.remove(d.down("#newscombo"));d.remove(d.down("#selectedschools"));d.down("#date").hide();break;case"publishnews":c+='id="schoolHotNews"></iframe>';d.remove(d.down("#newscombo"));b.add({region:"east",title:"学校选择",collapsible:true,width:200,style:{borderLeft:"3px #abcdef solid"},layout:"fit",items:[{xtype:"selectschool"}]});break;default:return 0}b.down("#center").add({xtype:"panel",html:c})}},"publishnews #previewbtn":{click:function(b){var d,c;if(!zy_ueditorReady){School.util.Util.showWarningMsg("正在加载相关文件，请稍候再试...");return 0}switch(b.up("publishnews").getItemId()){case"publishclassnews":d="classNews";break;case"publishschoolnews":d="schoolNews";break;case"publishschoolsummy":d="schoolSummy";break;case"publishnews":d="schoolHotNews";break;default:break}var c=$("#"+d)[0].contentWindow.UE;var f=Ext.create("School.view.news.PreviewNews",{itemId:d});f.add({xtype:"panel",html:'<iframe src="preview.html" id="previewWin" frameborder=0 width=100% height=100%></iframe>'});var e=c.getEditor("editor").getContent();setTimeout(function(){var g=$("#previewWin")[0].contentWindow;g.$(".container .row .col-md-12").html(e);g.$("img").addClass("img-responsive")},2000)}},"previewnews button#save":{click:function(d){var g,h,b,e,c;g=zyHost+"article/sendArticle.action";switch(d.up("previewnews").getItemId()){case"schoolNews":e="#schoolNews";h="publishschoolnews";c={type:Ext.ComponentQuery.query("#publishschoolnews")[0].down("form").getValues().type,title:Ext.ComponentQuery.query("#"+h)[0].down("#title").getValue(),schoolId:zy_schoolId};break;case"classNews":e="#classNews";h="publishclassnews";c={type:"educate",title:Ext.ComponentQuery.query("#"+h)[0].down("#title").getValue(),gradeId:Ext.ComponentQuery.query("#classnews")[0].down("#mygrades").getValue()};break;case"schoolSummy":e="#schoolSummy";h="publishschoolsummy";c={type:"summy",title:"校园简介",schoolId:zy_schoolId};break;case"schoolHotNews":e="#schoolHotNews";h="publishnews";c={type:"teaching",title:Ext.ComponentQuery.query("#"+h)[0].down("#title").getValue(),schoolId:zy_selectedSchools.join(",")};if(c.schoolId===""){School.util.Util.showErrorMsg("您没有选择可见学校，无法提交！");return 0}break;default:break}b=Ext.ComponentQuery.query("#"+h)[0].down("form");if(!b.getForm().isValid()){School.util.Util.showErrorMsg("新闻标题或发布日期不能为空!");return 0}var i=$(e)[0].contentWindow,f=i.UE.getEditor("editor").getContent(),j="";i.$(".div-hidden").html(f);i.$(".div-hidden img").addClass("img-responsive center-block");i.$(".div-hidden img").each(function(k){var m=this.src.indexOf("ueditorImg"),l=this.src.length;this.src="/"+this.src.substring(m,l);if(k===0){j="/"+this.src.substring(m,l)}});f=i.$(".div-hidden")[0].innerHTML;console.log(f);i.$(".div-hidden").html("");if(!j){School.util.Util.showErrorMsg("请在新闻内容里插入一张图片！");return}c.content=f;c.createTime=b.getValues().createTime;c.path=j;console.log(c);Ext.getBody().mask("正在提交新闻，请等待...","splashscreen");Ext.Ajax.request({url:zyHost+g,timeout:60000,params:c,success:function(o,p,t,q){Ext.getBody().unmask();var u=School.util.Util.decodeJSON(o.responseText);if(u.success){d.up("window").destroy();School.util.Util.showSuccessMsg("新闻提交成功!");b.up("publishnews").close();var m=Ext.ComponentQuery.query("mainpanel")[0];switch(h){case"publishschoolnews":var r="校园新闻",n="newsmgr";School.util.AddTab.addTab(m,r,n,"","schoolnews");var k=Ext.ComponentQuery.query("#schoolnews")[0];if(k){k.down("#newscombo").setValue(c.type);k.getStore().reload({params:{type:c.type,schoolId:zy_schoolId}})}break;case"publishclassnews":var r="年级新闻",n="newsmgr";School.util.AddTab.addTab(m,r,n,"","classnews");var l=Ext.ComponentQuery.query("#classnews")[0];if(l){l.down("#mygrades").setValue(c.gradeId);l.getStore().reload({params:{type:"educate",gradeId:c.gradeId}})}break;case"publishschoolsummy":var s=Ext.ComponentQuery.query("schoolsummy")[0];if(s){s.close()}var r="校园简介",n="schoolsummy";School.util.AddTab.addTab(m,r,n);break;case"publishnews":zy_selectedSchools=[];break}}else{School.util.Util.showErrorMsg("新闻提交失败!")}},failure:function(n,k,l,m){Ext.getBody().unmask();School.util.Util.showErrorMsg("链接服务器失败！")}})}}})}});Ext.define("School.controller.teacher.Position",{extend:"Ext.app.Controller",requires:["School.util.Util","Ext.ux.Tips"],views:["school.position.PositionMgr","school.position.PositionWin","school.position.AllocatePosition","school.position.TeacherInPosition"],refs:[{ref:"positionList",selector:"positionmgr"}],init:function(){var a=this;a.control({"positionmgr actioncolumn":{itemclick:function(c,b){switch(c){case"remove":a.rmPosition(b);break;case"detail":a.detailPosition(b);break}}},"positionmgr button#addPosition":{click:a.addPosition},"positionmgr button#allocatePosition":{click:a.allocatePosition},"positionmgr button#teacherInPosition":{click:a.getTeacherInPosition},"positionwin button#save":{click:a.savePosition},"allocateposition dataview":{drop:this.doAllocate},"allocateposition #undoAllocateGrid":{render:this.loadAllocatedTeacher},"allocateposition #doAllocateGrid":{afterrender:this.getUnAllocatedTeacher}})},getUnAllocatedTeacher:function(d){var b=this.getPositionList();var e=b.getSelectionModel().getSelection()[0],c=e.get("id");var f=d.getStore();var a=d.up("window").down("#undoAllocateGrid").getStore();f.load({callback:function(){a.load({params:{positionId:c},callback:function(h,g,i){Ext.each(h,function(j){f.remove(j)})}})}})},loadAllocatedTeacher:function(d){var a=this.getPositionList();var e=a.getSelectionModel().getSelection()[0],c=e.get("id");var b=d.getStore();b.load({params:{positionId:c}})},doAllocate:function(d,e,i,l){var g=e.records[0],b=g.get("name"),h=g.get("id"),j=e.view.panel.itemId;var f=this.getPositionList();var k=f.getSelectionModel().getSelection()[0],m=k.get("id");var a="",c="";if(j=="doAllocateGrid"){a="/school/teacher/addPosition.action";c="已分配"}else{a="/school/teacher/deletePosition.action";c="已移除"}Ext.Ajax.request({url:a,params:{positionId:m,teacherId:h},failure:function(n){School.util.Util.showErrorMsg(n.responseText)},success:function(n){n=School.util.Util.decodeJSON(n.responseText);if(!n.result){School.util.Util.showErrorMsg("操作失败");return 0}Ext.ux.Tips.msg("提示: ",c+b)}})},getTeacherInPosition:function(d){var b=this.getPositionList(),c=b.getStore();var a=b.getSelectionModel().getSelection()[0];if(!a){School.util.Util.showErrorMsg("请先选择一个职位");return 0}var e=Ext.widget("teacherinpositionwin");e.setTitle('"'+a.get("name")+'"职位下的所有教师');e.down("grid").getStore().load({params:{positionId:a.get("id")},callback:function(f){if(f.length===0){School.util.Util.showWarningMsg("该职位下没有分配教师")}}})},detailPosition:function(a){var d=Ext.widget("positionwin"),b=d.down("form");var c=a.get("name");d.setTitle('"'+c+'"职位的详细信息');b.loadRecord(a)},allocatePosition:function(d){var b=this.getPositionList(),c=b.getStore();var a=b.getSelectionModel().getSelection()[0];if(!a){School.util.Util.showErrorMsg("请先选择一个职位");return 0}var e=Ext.widget("allocateposition");e.setTitle('给"'+a.get("name")+'"职位分配教师')},rmPosition:function(a){var c=this;var b=a.get("id");var d=a.get("name");Ext.Msg.confirm({title:"警告",msg:'你确定要删除"'+d+'"职位? 删除后，已分配了该职位的人员会失去该职位!!',icon:Ext.Msg.WARNING,buttons:Ext.Msg.YESNO,fn:function(e){if(e!="yes"){return 0}Ext.Ajax.request({url:"/school/teacher_position/deletePosition.action",params:{positionId:b},failure:function(f){School.util.Util.showErrorMsg(f.responseText)},success:function(f){f=School.util.Util.decodeJSON(f.responseText);if(!f.result){School.util.Util.showErrorMsg("操作失败");return 0}School.util.Util.showSuccessMsg('已成功删除"'+d+'"职位');c.getPositionList().getStore().load()}})}})},savePosition:function(b){var c=this;win=b.up("window"),form=win.down("form"),store=this.getPositionList().getStore(),formValues=form.getValues();formValues.schoolId=zy_schoolId;if(!form.getForm().isValid()){School.util.Util.showErrorMsg("请填写必要的信息");return 0}var a=!formValues.id?"/school/teacher_position/addPosition.action":"/school/teacher_position/updatePosition.action";Ext.Ajax.request({url:a,params:formValues,method:"POST",success:function(d){d=School.util.Util.decodeJSON(d.responseText);if(!d.result){School.util.Util.showErrorMsg("操作失败");return 0}var e=formValues.name;School.util.Util.showSuccessMsg("已成功保存"+e+'"职位');win.destroy();c.getPositionList().getStore().load()},failure:function(d){School.util.Util.showErrorMsg("添加失败")}})},addPosition:function(a){var b=Ext.widget("positionwin");b.setTitle("新增职位")}});Ext.define("School.controller.clazz.Health",{extend:"Ext.app.Controller",requires:["School.util.Util","Ext.form.field.File"],views:["clazz.health.HealthMgr","clazz.health.UploadHealthWin","clazz.health.StudentHealthWin"],stores:["School.store.clazz.Health"],refs:[{ref:"healthList",selector:"healthmgr"}],init:function(){var a=this;this.control({healthmgr:{render:this.setParamsForStore},"healthmgr combobox":{render:this.setDefaultClass,change:this.setClassIdAndName},"healthmgr toolbar #deleteHealth":{click:this.doDeleteStudentHealth},"healthmgr toolbar #editHealth":{click:this.editStudentHealth},"studenthealthwin #saveHealth":{click:this.doSaveStudentHealth},"healthmgr button#uploadHealth":{click:this.uploadHealthWin},"healthmgr button#downloadHealth":{click:this.doDownloadHealth},"healthmgr button#refresh":{click:this.loadStore},"uploadhealthwin button#save":{click:this.doUploadHealth}})},setDefaultClass:function(a){a.setValue(zy_classId);this.setClassIdAndName(a)},setClassIdAndName:function(a){this.classId=a.getValue();this.className=a.getRawValue();this.loadStore()},setParamsForStore:function(){var b=this;var a=Ext.getStore("healthStore");a.addListener("beforeload",function(d,c){d.getProxy().setExtraParam("classId",b.classId)})},doDeleteStudentHealth:function(c){var d=this,e=this.getHealthList(),b=e.getStore();var a=e.getSelectionModel().getSelection()[0];if(!a){School.util.Util.showErrorMsg("请先选择一名学生");return 0}var f='你确定删除"'+a.get("studentName")+'"的健康信息？若删除后，将无法恢复';School.util.Util.confirm(f,function(g){if(g!="yes"){return 0}Ext.Ajax.request({url:"/school/healthy/deleteHealthy.action",params:{healthyId:a.get("id")},failure:function(h){School.util.Util.showErrorMsg(h.responseText)},success:function(h){var i=School.util.Util.decodeJSON(h.responseText);if(!i.success){School.util.Util.showErrorMsg("操作失败");return 0}School.util.Util.showSuccessMsg('成功删除"'+a.get("studentName")+'"的健康信息');d.loadStore()}})})},doSaveStudentHealth:function(a){var c=this,d=a.up("window"),b=d.down("form");b.getForm().submit({url:"/school/healthy/updateHealthy.action",failure:function(e,f){School.util.Util.showErrorMsg(f.result)},success:function(f,g){var e=g.result;if(!e.success){School.util.Util.showErrorMsg("操作失败");return 0}School.util.Util.showSuccessMsg('成功保存"'+f.getValues().studentName+'"的健康信息');c.loadStore(c.getHealthList())}})},editStudentHealth:function(c){var e=this.getHealthList();var b=e.getStore();var a=e.getSelectionModel().getSelection()[0];if(!a){School.util.Util.showErrorMsg("请先选择一名学生");return 0}var f=Ext.widget("studenthealthwin");f.setTitle('正在编辑"'+a.get("studentName")+'"的健康信息');var d=f.down("form");d.loadRecord(a)},doDownloadHealth:function(c){var a="";var b="/school/healthy/downClassHealthy.action";a='<input type="text" name="classId" value="'+this.classId+'"/><input type="text" name="className" value="'+this.className+'"/>';School.util.Util.downloadFile(b,a)},doUploadHealth:function(c){var b="/school/healthy/uploadHealthy.action",e="该文件类型不是excel文件，请重新选择！",d={file:c.up("form").down("filefield").getValue(),clazzId:zy_classId};var a=School.util.Util.uploadFile(c,b,d,e);if(!a){return 0}this.getClassHealthStore().load({params:zy_classId})},uploadHealthWin:function(a){Ext.widget("uploadhealthwin")},loadStore:function(b){var a=this.getHealthList().getStore();a.load()}});Ext.define("School.controller.push.Push",{extend:"Ext.app.Controller",requires:["School.util.Util","School.store.push.Contact"],views:["push.PushPanel","push.ContactTree"],stores:[],refs:[{ref:"pushPanel",selector:"pushpanel"},{ref:"contactTree",selector:"contacttree"}],init:function(a){this.control({"pushpanel contacttree":{render:this.setTreeData,checkchange:this.selectReceiver},"pushpanel button#doSend":{click:this.doSendMsg},"pushpanel button#reset":{click:this.resetContent}})},paramsToBackend:[],receiversName:[],selectReceiver:function(d,c){var b=this;if(!d.raw.leaf){Ext.each(d.childNodes,function(e){e.set("checked",c);b.selectSingle(e)})}else{this.selectSingle(d)}var a=b.getPushPanel().down("#receiverName");a.setValue(Ext.Array.unique(this.receiversName).toString())},selectSingle:function(d){var f=this.getPushPanel().down("form"),e=f.down("#receiverName");var a=e.getValue(),c=d.raw.name,g=d.raw.id,b=d.raw.studentId||" ";if(d.get("checked")){this.receiversName.push(c);this.paramsToBackend.push({receiverId:g,studentId:b})}else{Ext.Array.remove(this.receiversName,c);this.paramsToBackend=this.paramsToBackend.filter(function(j,i,h){return j.receiverId!=g})}},setTreeData:function(c){var b=c.getStore(),a=b.getRootNode();var d=[];Ext.Ajax.request({url:"/school/contact/getTeacherContactForWeb.action",async:false,success:function(f){var e=School.util.Util.decodeJSON(f.responseText);delete e.success;Ext.Object.each(e,function(g,h){Ext.each(h,function(k,j){var i=k.position;k.name=k.name+(i?i.toString():"");k.leaf=true;k.checked=false});d.push({name:g,children:h,checked:false})})}});Ext.Ajax.request({url:"/school/contact/getParentContactForWeb.action",async:false,success:function(f){var e=School.util.Util.decodeJSON(f.responseText);delete e.success;Ext.Object.each(e,function(g,h){Ext.each(h,function(j,i){j.name=j.studentName;j.id=j.parentId;j.leaf=true;j.checked=false});d.push({name:g,children:h,checked:false})})}});b.setRootNode({expanded:true,children:d})},doSendMsg:function(){var d=this,c=this.getPushPanel().down("form"),h=c.getValues();var b=School.util.Util.unique(d.paramsToBackend);var a=[],f=[];Ext.each(b,function(j,i){a.push(j.receiverId);f.push(j.studentId)});var e={senderId:globalUserInfo.user_id,content:h.content,receiversId:a.join(","),studentsId:f.join(",")};var g=Ext.Msg.wait("正在发送，请耐心等待");Ext.Ajax.request({url:"/school/push/saveShortMessage.action",params:e,failure:function(j){var i=School.util.Util.decodeJSON(j.responseText);School.util.Util.showErrorMsg(i)},success:function(k){var j=School.util.Util.decodeJSON(k.responseText),i=Ext.ComponentQuery.query("msglist")[0];if(!j.success){School.util.Util.showErrorMsg(j.msg);return 0}School.util.Util.showSuccessMsg("发送成功");i&&i.getStore()&&i.getStore().reload();d.paramsToBackend=[];d.receiversName=[];c.getForm().reset();d.setTreeData(d.getContactTree())}})},resetContent:function(b){var a=this.getPushPanel().down("[name=content]");a.setValue("")}});Ext.define("School.controller.push.MsgList",{extend:"Ext.app.Controller",views:["push.MsgList"],init:function(a){this.control({"msglist button#query":{click:function(f){var g,d,c,b,e;g=f.up("toolbar");d=g.down("#beginTime");c=g.down("#endTime");if(!d.isValid()||!c.isValid()){School.util.Util.showErrorMsg("日期格式不正确，请重新输入");return 0}b=d.getRawValue();e=c.getRawValue();g.up("msglist").getStore().reload({params:{beginTime:b,endTime:e}})}}})}});Ext.define("School.controller.clazz.Appraise",{extend:"Ext.app.Controller",requires:[],stores:["school.Semester"],views:["clazz.appraise.AppraiseMgr","clazz.appraise.AppraiseWin","clazz.appraise.WordTpl","clazz.appraise.IdentityWin"],refs:[{ref:"appraiseList",selector:"appraisemgr"},{ref:"termCombo",selector:"appraisemgr combo#termCombo"},{ref:"stageCombo",selector:"appraisemgr combo#stageCombo"},{ref:"classCombo",selector:"appraisemgr combo#classCombo"},{ref:"identityCombo",selector:"appraisemgr combo#identityCombo"},{ref:"identityWin",selector:"identitywin"},{ref:"wordTplList",selector:"wordtpl"}],init:function(a){this.control({appraisemgr:{selectionchange:this.checkIfAppraised},"appraisemgr #classCombo":{render:this.setDefaultClass},"appraisemgr #termCombo":{render:this.setDefaultTerm},"appraisemgr toolbar button#add":{click:this.addAppraiseWin},"appraisemgr toolbar button#edit":{click:this.editAppraiseWin},"appraisemgr toolbar button#delete":{click:this.rmAppraise},"appraisemgr toolbar button#download":{click:this.doDownloadAppraise},"appraisemgr combo":{select:this.loadAppraiseList},"appraisewin button#save":{click:this.doSaveAppraise},"appraisewin button#reset":{click:this.resetForm},"appraisewin wordtpl":{selectionchange:this.doSelectTpl,render:this.getSubjectWordTpl}})},doSelectTpl:function(a,d){var e=a.view.up("window").down("form"),c=e.down("[name=word]");if(!d.length){c.setValue("");return 0}var b=d[0].get("word");c.setValue(b)},getSubjectWordTpl:function(d){var e=this.getIdentityCombo(),a=e.findRecordByValue(e.getValue()),c=a.get("subject");var b=this.getWordTplList().getStore();b.load({params:{subject:c},callback:function(f){if(f&&f.length===0){School.util.Util.showWarningMsg("该科目下的评语模版为空")}}})},editAppraiseWin:function(a){var d=this.getSelectedStudent();var c=Ext.widget("appraisewin");c.setTitle('正在编辑"'+d.records[0].get("studentName")+'"...等学生的评价信息');c.show();var b=c.down("form");b.loadRecord(d.records[0])},doSaveAppraise:function(d){var j=this,i=d.up("window"),b=i.down("form");var f=b.getValues();var l=j.getAppraiseList(),h=l.down("#classCombo"),k=l.down("#stageCombo"),e=l.down("#identityCombo");f.class_id=h.getValue();f.stage=k.getValue();f.type=e.getValue();var g=this.getSelectedStudent();var c=false;Ext.each(g.records,function(o,n,m){if(o.get("id")){c=true;return 0}});var a="";if(c){a="/school/appraise/updateAppraise.action";f.appraise_id=g.appraiseIds.join(",")}else{a="/school/appraise/saveAppraise.action";f.studentIds=g.studentIds.join(",")}Ext.Msg.wait("请耐心等待");Ext.Ajax.request({url:a,params:f,failure:function(m){School.util.Util.showErrorMsg(m)},success:function(n){var m=School.util.Util.decodeJSON(n.responseText);if(!m.success){School.util.Util.showErrorMsg("操作失败");return 0}School.util.Util.showSuccessMsg("操作成功");j.loadAppraiseList();i.close()}})},addAppraiseWin:function(a){var c=this.getSelectedStudent();if(!c){return 0}var b=Ext.widget("appraisewin");b.setTitle('正在编辑"'+c.records[0].get("studentName")+'"...等学生的评价信息');b.show()},doDownloadAppraise:function(){var a="";var b="/school/appraise/downloadAppraise.action";a='<input type="text" name="Semester" value="'+this.getTermCombo().getValue()+'"/><input type="text" name="stage" value="'+this.getStageCombo().getValue()+'"/><input type="text" name="classid" value="'+this.getClassCombo().getValue()+'"/><input type="text" name="type" value="'+this.getIdentityCombo().getValue()+'"/>';School.util.Util.downloadFile(b,a)},rmAppraise:function(b){var c=this.getSelectedStudent(),a=c.records;Ext.Msg.wait("请耐心等待");Ext.Ajax.request({scope:this,url:"/school/appraise/deleteAppraise.action",params:{ids:c.appraiseIds.join(",")},failure:function(d){School.util.Util.showErrorMsg(d)},success:function(e){var d=School.util.Util.decodeJSON(e.responseText);if(!d.success){School.util.Util.showErrorMsg(d.msg||"操作失败");return 0}School.util.Util.showSuccessMsg('成功删除"'+a[0].get("studentName")+'"等学生的评价');this.loadAppraiseList()}})},loadAppraiseList:function(b){var c=this.getAppraiseList(),a=c.getStore();a.removeAll();a.load({params:{classid:this.getClassCombo().getValue(),Semester:this.getTermCombo().getValue(),stage:this.getStageCombo().getValue(),type:this.getIdentityCombo().getValue()},callback:function(d){if(!d){School.util.Util.showWarningMsg("没有评价数据");return 0}}})},setDefaultClass:function(a){a.setValue(zy_classId)},setDefaultTerm:function(b){var a=b.getStore();a.load({scope:this,callback:function(d,c,e){if(!d){School.util.Util.showErrorMsg("学期列表为空");return 0}b.setValue(d[0].get("id"))}})},setIdentity:function(){},getSelectedStudent:function(d){var c=this.getAppraiseList();var b=c.getStore();var a=c.getSelectionModel().getSelection();if(!d&&!a.length){School.util.Util.showErrorMsg("请先选择一名学生");return 0}var e=[],f=[];Ext.each(a,function(g,h){e.push(g.get("studentId"));f.push(g.get("id"))});return{records:a,appraiseIds:f,studentIds:e}},resetForm:function(a){var b=a.up("window").down("form");b.getForm().reset()},checkIfAppraised:function(h,e){var g=this.getAppraiseList(),a=g.down("button#add"),c=g.down("button#edit"),f=g.down("button#delete");var i=this.getSelectedStudent(true);var d=null,b=null;Ext.each(i.records,function(j){var k=j.get("id");if(k){b=true}else{d=true}if(b){a.setDisabled(true);c.setDisabled(false);f.setDisabled(false)}if(d){a.setDisabled(false);c.setDisabled(true);f.setDisabled(true)}if(b&&d){a.setDisabled(true);c.setDisabled(true);f.setDisabled(true)}})}});Ext.define("School.controller.auth.Role",{extend:"Ext.app.Controller",requires:[],views:["auth.role.RoleMgr","auth.role.RoleWin","auth.role.ArrangeRole","auth.role.ArrangeRoleWin"],refs:[{ref:"roleGrid",selector:"rolemgr"},{ref:"roleWin",selector:"rolewin"},{ref:"arrangeRoleGrid",selector:"arrangerole"},{ref:"arrangeRoleWin",selector:"arrangerolewin"}],init:function(a){this.control({rolemgr:{render:this.loadRoleGrid},"rolemgr button#add":{click:this.showRoleWin},"rolemgr button#edit":{click:this.editRole},"rolemgr button#delete":{click:this.deleteRole},"rolewin button#undo":{click:this.unShowRoleWin},"rolewin button#save":{click:this.saveRole},arrangerole:{render:this.loadArrangeRoleGrid},"arrangerole #arrangeBtn":{click:this.showArrangeRoleWin},"arrangerolewin #arrangedGrid":{render:this.loadArrangedRole},"arrangerolewin #unarrangedGrid":{render:this.loadUnarrangedRole},"arrangerolewin button#cancel":{click:this.unShowRoleWin},"arrangerolewin button#save":{click:this.doSaveArrangeRole}})},doSaveArrangeRole:function(a){var c=this.getArrangeRoleWin(),b=c.down("#arrangedGrid"),e=b.getStore().getRange();var d=[];Ext.each(e,function(f){d.push(f.get("id"))});Ext.Ajax.request({scope:this,url:"/school/role/arrange_role.action",params:{userId:this.getSelectedUser()[0].get("id"),roles:d},failure:function(f){School.util.Util.showErrorMsg("操作失败")},success:function(g){var f=School.util.Util.decodeJSON(g.responseText);if(!f.success){School.util.Util.showErrorMsg("操作失败");return 0}School.util.Util.showSuccessMsg("操作成功");this.getArrangeRoleGrid().getStore().load();c.destroy()}})},loadArrangedRole:function(c){var b=this.getSelectedUser()[0];var a=c.getStore();a.load({url:"/school/role/role_list_by_user_id.action",params:{userId:b.get("id")}})},loadUnarrangedRole:function(c){var b=this.getSelectedUser()[0];var a=c.getStore();a.load({url:"/school/role/unarranged_role_list_by_user_id.action",params:{userId:b.get("id")}})},showArrangeRoleWin:function(b){var a=this.getSelectedUser()[0];if(!a){School.util.Util.showErrorMsg("请先选择一名人员");return 0}var c=Ext.widget("arrangerolewin",{autoShow:true,title:'正在为"'+a.get("name")+'"分配角色(拖动即可分配)'})},loadArrangeRoleGrid:function(b){var a=this.getArrangeRoleGrid().getStore();a.load()},getSelectedUser:function(){var a=this.getArrangeRoleGrid();return a.getSelectionModel().getSelection()},getSeletedRecord:function(){var a=this.getRoleGrid();return a.getSelectionModel().getSelection()},loadRoleGrid:function(){var a=this.getRoleGrid().getStore();a.load()},deleteRole:function(b){var a=this.getSeletedRecord()[0];if(!a){School.util.Util.showErrorMsg("请先选择一名用户");return 0}Ext.Ajax.request({scope:this,url:"/school/role/del_role.action",params:{roleId:a.get("id")},failure:function(c){School.util.Util.showErrorMsg(c.responseText)},success:function(d){var c=School.util.Util.decodeJSON(d.responseText);if(!c.success){School.util.Util.showErrorMsg("操作失败");return 0}School.util.Util.showSuccessMsg('已成功删除"'+a.get("role")+'"该角色');this.getRoleGrid().getStore().load()}})},editRole:function(){var a=this.getSeletedRecord()[0];if(!a){School.util.Util.showErrorMsg("请先选择你想要修改的角色");return 0}var b=Ext.widget("rolewin");var c=b.down("form");c.loadRecord(a);b.setTitle(a.get("role")+" 的基本信息");b.show()},saveRole:function(b){var e=b.up("window");var c=e.down("form");if(!c.getForm().isValid()){School.util.Util.showErrorMsg("请填写必要的信息");return 0}var d=c.getValues();var a="";a=d.id?"/school/role/edit_role.action?":"/school/role/add_role.action";Ext.Ajax.request({scope:this,url:a,params:d,failure:function(f){School.util.Util.showErrorMsg("无法提交或者提交失败")},success:function(g){var f=School.util.Util.decodeJSON(g.responseText);if(!f.success){School.util.Util.showErrorMsg("操作失败");return 0}School.util.Util.showSuccessMsg("操作成功");this.getRoleGrid().getStore().load();this.unShowRoleWin(b)}})},unShowRoleWin:function(a){var b=a.up("window");b&&(b.destroy())},showRoleWin:function(a){var b=Ext.widget("rolewin");b.setTitle("新增角色窗口");b.show()}});Ext.define("School.controller.auth.Module",{extend:"Ext.app.Controller",requires:["School.util.Util"],views:["auth.module.ArrangeModule","auth.module.ArrangeModuleWin","auth.module.BtnPermission","auth.module.ArrangeBtnPermissionWin"],refs:[{ref:"arrangeModuleGrid",selector:"arrangemodule"},{ref:"arrangeModuleWin",selector:"arrangemodulewin"},{ref:"btnPermissionGrid",selector:"btnpermission"},{ref:"arrangeBtnPermissionWin",selector:"arrangebtnpermissionwin"}],init:function(a){this.control({arrangemodule:{render:this.loadArrangeModule},"arrangemodule button#arrangeBtn":{click:this.showArrangeModuleWin},"arrangemodulewin treepanel":{render:this.loadModuleTree,checkchange:this.checkModule},"arrangemodulewin button#save":{click:this.doSaveArrange},"btnpermission combo#selectRole":{change:this.loadParentModule},"btnpermission combo#selectParentModule":{change:this.loadChildModule},"btnpermission combo#selectChildModule":{change:this.loadBtnPermission},"btnpermission button#arrangeBtn":{click:this.showArrangePermissionWin},"arrangebtnpermissionwin #unarrangedGrid":{render:this.loadUnarrangedBtnPermission},"arrangebtnpermissionwin #arrangedGrid":{render:this.loadarrangedBtnPermission},"arrangebtnpermissionwin button#save":{click:this.doSaveBtnPermission}})},doSaveBtnPermission:function(a){var d=a.up("window"),c=d.down("#arrangedGrid"),e=c.getStore().getRange();var b=[];Ext.each(e,function(f){b.push(f.get("id"))});Ext.Ajax.request({scope:this,url:"/school/permission/arrange_permission.action",params:{roleId:this.getRoleCombo().getValue(),moduleId:this.getChildModuleCombo().getValue(),permissions:b||[]},failure:function(f){School.util.Util.showErrorMsg("操作失败")},success:function(g){var f=School.util.Util.decodeJSON(g.responseText);if(!f.success){School.util.Util.showErrorMsg("操作失败");return 0}School.util.Util.showSuccessMsg("操作成功");this.getBtnPermissionGrid().getStore().load({params:{roleId:this.getRoleCombo().getValue(),moduleId:this.getChildModuleCombo().getValue()}});d.destroy()}})},loadarrangedBtnPermission:function(b){var a=b.getStore();a.load({params:{roleId:this.getRoleCombo().getValue(),moduleId:this.getChildModuleCombo().getValue()}})},loadUnarrangedBtnPermission:function(b){var a=b.getStore();a.load({url:"/school/permission/unarranged_permission_list_by_role_module_id.action",params:{roleId:this.getRoleCombo().getValue(),moduleId:this.getChildModuleCombo().getValue()},callback:function(c){if(c&&!c.length){School.util.Util.showWarningMsg("可分配的按钮为空或者已经分配完毕")}}})},showArrangePermissionWin:function(a){Ext.widget("arrangebtnpermissionwin",{autoShow:true,title:"正在分配按钮权限(向右拖动即可分配)"})},loadParentModule:function(){var a=this.getParentModuleCombo();a.reset();a.setDisabled(false);this.getChildModuleCombo().reset();a.getStore().load({url:"/school/module/father_module_list_by_role_id.action",params:{roleId:this.getRoleCombo().getValue()},callback:function(b){if(b&&!b.length){School.util.Util.showWarningMsg("该角色的父模块为空");a.setDisabled(true)}}})},loadChildModule:function(b){var a=this.getChildModuleCombo();a.reset();a.setDisabled(false);a.getStore().load({url:"/school/module/son_module_list_by_father_module_id.action",params:{fatherModuleId:this.getParentModuleCombo().getValue(),roleId:this.getRoleCombo().getValue()},callback:function(c){if(c&&!c.length){School.util.Util.showWarningMsg("该父模块的子模块为空");a.setDisabled(true)}}})},loadBtnPermission:function(c){var b=this.getBtnPermissionGrid();var a=b.getStore();a.load({params:{roleId:this.getRoleCombo().getValue(),moduleId:this.getChildModuleCombo().getValue()},callback:function(d){if(!d||d.length<=0){School.util.Util.showWarningMsg("该角色和模块对应的按钮权限为空")}}})},doSaveArrange:function(){var d=this.getArrangeModuleWin(),a=d.down("#moduleTree"),c=a.getChecked();var b=[];Ext.each(c,function(e){b.push(e.get("id"))});Ext.Ajax.request({scope:this,url:"/school/module/arrange_module.action",params:{roleId:this.getSelectedRole()[0].get("id"),modules:b},failure:function(e){School.util.Util.showErrorMsg("操作失败")},success:function(f){var e=School.util.Util.decodeJSON(f.responseText);if(!e.success){School.util.Util.showErrorMsg("操作失败");return 0}School.util.Util.showSuccessMsg("操作成功");this.getArrangeModuleGrid().getStore().load();d.destroy()}})},getSelectedRole:function(){var a=this.getArrangeModuleGrid();return a.getSelectionModel().getSelection()},checkModule:function(c,b){if(!c.raw.leaf){c.expand();Ext.each(c.childNodes,function(d){d.set("checked",b)})}else{var a=c.parentNode;if(!a.get("checked")){a.set("checked",b)}}},loadModuleTree:function(b){var c=b.getStore();var a=this.getSelectedRole()[0];c.load({url:"/school/module/module_tree_by_role_id.action",params:{roleId:a.get("id")}})},loadArrangeModule:function(c){var b=c?c:this.getModuleGrid();var a=c.getStore();a.load()},showArrangeModuleWin:function(b){var a=this.getSelectedRole()[0];if(!a){School.util.Util.showErrorMsg("请先选择一个角色");return 0}Ext.widget("arrangemodulewin",{autoShow:true,title:"给角色分配模块窗口"})},loadArrangedModule:function(c){var a=this.getSelectedRole()[0];var b=c.getStore();b.load({url:"/school/module/module_list_by_role_id.action",params:{roleId:a.get("id")}})},loadUnarrangedModule:function(c){var a=this.getSelectedRole()[0];var b=c.getStore();b.load({url:"/school/module/unarranged_module_list_by_role_id.action",params:{roleId:a.get("id")}})},getRoleCombo:function(){var a=this.getBtnPermissionGrid();return a.down("combo#selectRole")},getParentModuleCombo:function(){var a=this.getBtnPermissionGrid();return a.down("combo#selectParentModule")},getChildModuleCombo:function(){var a=this.getBtnPermissionGrid();return a.down("combo#selectChildModule")}});